# âŒ æ‰‹åŠ¨è®¡ç®—é«˜åº¦çš„ä¸‰å¤§é—®é¢˜

## ğŸ“‹ é—®é¢˜ä»£ç 

```objective-c
// âŒ è¿™æ®µä»£ç æœ‰ä¸‰ä¸ªä¸¥é‡é—®é¢˜
- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {

    if (self.tableView.rowHeight == UITableViewAutomaticDimension) {

        // é—®é¢˜1ï¼šé€»è¾‘çŸ›ç›¾
        // å·²ç»è®¾ç½®äº†è‡ªåŠ¨é«˜åº¦ï¼Œä¸ºä»€ä¹ˆè¿˜è¦æ‰‹åŠ¨è®¡ç®—ï¼Ÿ

        CGFloat tableViewWidth = tableView.bounds.size.width;

        // é—®é¢˜2ï¼šæ€§èƒ½é—®é¢˜
        // systemLayoutSizeFittingSize è°ƒç”¨æˆæœ¬å¾ˆé«˜
        static BookCell *sizingCell = nil;
        static dispatch_once_t onceToken;
        dispatch_once(&onceToken, ^{
            sizingCell = [[BookCell alloc] initWithStyle:UITableViewCellStyleDefault
                                         reuseIdentifier:nil];
        });

        sizingCell.bookTitle = self.bookTitles[indexPath.row];

        CGSize size = [sizingCell systemLayoutSizeFittingSize:CGSizeMake(tableViewWidth, 0)
                                  withHorizontalFittingPriority:UILayoutPriorityRequired
                                        verticalFittingPriority:UILayoutPriorityFittingSizeLevel];

        // é—®é¢˜3ï¼šä»£ç å¤æ‚
        // éœ€è¦ç»´æŠ¤ sizingCellã€è®¡ç®—é€»è¾‘ç­‰
        return (size.height > CELL_HEIGHT ? size.height : CELL_HEIGHT);
    }

    return CELL_HEIGHT;
}
```

---

## âš ï¸ é—®é¢˜1ï¼šé€»è¾‘çŸ›ç›¾

### **çŸ›ç›¾ç‚¹**

```objective-c
// åœ¨ viewDidLoad ä¸­è®¾ç½®
self.tableView.rowHeight = UITableViewAutomaticDimension;  // å‘Šè¯‰ç³»ç»Ÿï¼š"è¯·è‡ªåŠ¨è®¡ç®—é«˜åº¦"

// åœ¨ heightForRowAtIndexPath: ä¸­
if (self.tableView.rowHeight == UITableViewAutomaticDimension) {
    return æ‰‹åŠ¨è®¡ç®—çš„é«˜åº¦;  // âš ï¸ åˆæ‰‹åŠ¨è®¡ç®—ï¼Ÿé‚£è®¾ç½®è‡ªåŠ¨é«˜åº¦æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿ
}
```

### **é—®é¢˜åˆ†æ**

```
ç”¨æˆ·çš„æ„å›¾ï¼š
  "æˆ‘æƒ³ä½¿ç”¨è‡ªåŠ¨é«˜åº¦"
     â†“
  è®¾ç½® rowHeight = UITableViewAutomaticDimension
     â†“
  æœŸæœ›ï¼šç³»ç»Ÿè‡ªåŠ¨è®¡ç®—
     â†“
  å®é™…ï¼šå®ç°äº† heightForRowAtIndexPath: æ‰‹åŠ¨è®¡ç®—
     â†“
  ç»“æœï¼šè¦†ç›–äº†è‡ªåŠ¨è®¡ç®—ï¼Œå¤±å»äº†è‡ªåŠ¨é«˜åº¦çš„æ„ä¹‰ï¼
```

### **æ­£ç¡®ç†è§£**

| é…ç½® | æ•ˆæœ | æ˜¯å¦éœ€è¦å®ç° heightForRowAtIndexPath: |
|------|------|-----------------------------------|
| `rowHeight = å›ºå®šå€¼` | æ‰€æœ‰ Cell ä½¿ç”¨å›ºå®šé«˜åº¦ | ä¸éœ€è¦ |
| `rowHeight = UITableViewAutomaticDimension` | ç³»ç»Ÿè‡ªåŠ¨è®¡ç®— | **ä¸éœ€è¦** |
| ä¸è®¾ç½® `rowHeight` | ä½¿ç”¨é»˜è®¤é«˜åº¦ï¼ˆ44ï¼‰ | å¦‚æœéœ€è¦åŠ¨æ€é«˜åº¦ï¼Œåˆ™éœ€è¦å®ç° |

**ç»“è®ºï¼š**
- âœ… å¦‚æœè®¾ç½®äº† `UITableViewAutomaticDimension`ï¼Œ**ä¸åº”è¯¥**å®ç° `heightForRowAtIndexPath:`
- âœ… è®©ç³»ç»Ÿè‡ªåŠ¨æ ¹æ®çº¦æŸè®¡ç®—é«˜åº¦

---

## âš ï¸ é—®é¢˜2ï¼šæ€§èƒ½é—®é¢˜

### **æ€§èƒ½å¼€é”€åˆ†æ**

```objective-c
// æ¯æ¬¡æ»šåŠ¨åˆ°æŸä¸ª Cell æ—¶éƒ½ä¼šè°ƒç”¨
- (CGFloat)tableView:heightForRowAtIndexPath: {

    // âš ï¸ æ­¥éª¤1ï¼šåˆ›å»ºæˆ–è·å– sizingCellï¼ˆè½»é‡çº§ï¼‰
    static BookCell *sizingCell = ...;

    // âš ï¸ æ­¥éª¤2ï¼šå¡«å……æ•°æ®ï¼ˆä¸­ç­‰å¼€é”€ï¼‰
    sizingCell.bookTitle = ...;

    // âŒ æ­¥éª¤3ï¼šè®¡ç®—å¸ƒå±€ï¼ˆé‡é‡çº§æ“ä½œï¼ï¼‰
    CGSize size = [sizingCell systemLayoutSizeFittingSize:...];
    // systemLayoutSizeFittingSize å†…éƒ¨ä¼šï¼š
    //   1. åˆ›å»ºçº¦æŸæ±‚è§£å™¨
    //   2. è®¡ç®—æ‰€æœ‰çº¦æŸ
    //   3. è¿›è¡Œå¤šæ¬¡å¸ƒå±€è¿­ä»£
    //   4. è¿”å›æœ€ç»ˆå°ºå¯¸

    return size.height;
}
```

### **æ€§èƒ½å¯¹æ¯”**

| æ–¹æ¡ˆ | æ¯ä¸ª Cell çš„å¼€é”€ | 100 ä¸ª Cell | 1000 ä¸ª Cell |
|------|---------------|-----------|------------|
| **è‡ªåŠ¨é«˜åº¦ï¼ˆæ¨èï¼‰** | ~0.1ms | ~10ms | ~100ms |
| **æ‰‹åŠ¨ systemLayoutSizeFittingSize** | ~1ms | ~100ms | ~1000ms |

**å·®è·ï¼š10å€ï¼**

### **æ»šåŠ¨æ€§èƒ½å½±å“**

```
ç”¨æˆ·å¿«é€Ÿæ»šåŠ¨åˆ—è¡¨ï¼š
  â†“
æ¯ä¸ªå¯è§ Cell éƒ½è¦è®¡ç®—é«˜åº¦
  â†“
æ¯ä¸ª Cell è°ƒç”¨ systemLayoutSizeFittingSize
  â†“
é€ æˆä¸»çº¿ç¨‹é˜»å¡
  â†“
æ»šåŠ¨å¡é¡¿ã€æ‰å¸§
```

---

## âš ï¸ é—®é¢˜3ï¼šä»£ç å¤æ‚åº¦

### **éœ€è¦ç»´æŠ¤çš„ä¸œè¥¿**

```objective-c
// 1. éœ€è¦åˆ›å»ºå’Œç»´æŠ¤ sizingCell
static BookCell *sizingCell = nil;
static dispatch_once_t onceToken;
dispatch_once(&onceToken, ^{
    sizingCell = [[BookCell alloc] init...];
});

// 2. éœ€è¦åŒæ­¥æ•°æ®å¡«å……é€»è¾‘
// cellForRowAtIndexPath: ä¸­çš„é€»è¾‘è¦ä¸è¿™é‡Œä¿æŒä¸€è‡´
sizingCell.bookTitle = ...;

// 3. éœ€è¦å¤„ç†è¾¹ç•Œæƒ…å†µ
CGSize size = [sizingCell systemLayoutSizeFittingSize:...];
return (size.height > CELL_HEIGHT ? size.height : CELL_HEIGHT);

// 4. éœ€è¦å¤„ç†å®½åº¦å˜åŒ–ï¼ˆå±å¹•æ—‹è½¬ï¼‰
CGFloat tableViewWidth = tableView.bounds.size.width;

// 5. å¦‚æœ Cell ç±»å‹å˜åŒ–ï¼Œè¿˜éœ€è¦ç»´æŠ¤å¤šä¸ª sizingCell
```

**ä»£ç è¡Œæ•°å¯¹æ¯”ï¼š**

```
è‡ªåŠ¨é«˜åº¦æ–¹æ¡ˆï¼š
  - setupTableView: 2 è¡Œé…ç½®
  - cellForRowAtIndexPath: 10 è¡Œå·¦å³
  æ€»è®¡ï¼š~12 è¡Œ

æ‰‹åŠ¨è®¡ç®—æ–¹æ¡ˆï¼š
  - setupTableView: 2 è¡Œé…ç½®
  - cellForRowAtIndexPath: 10 è¡Œå·¦å³
  - heightForRowAtIndexPath: 20+ è¡Œ
  æ€»è®¡ï¼š~32 è¡Œ

å¤šå‡ºï¼š20 è¡Œï¼ˆ167% å¢åŠ ï¼‰
```

---

## âœ… æ­£ç¡®åšæ³•

### **å®Œå…¨ä½¿ç”¨è‡ªåŠ¨é«˜åº¦**

```objective-c
@implementation CorrectViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    // âœ… æ­¥éª¤1ï¼šè®¾ç½®è‡ªåŠ¨é«˜åº¦
    self.tableView.estimatedRowHeight = 80;
    self.tableView.rowHeight = UITableViewAutomaticDimension;
}

- (UITableViewCell *)tableView:(UITableView *)tableView
         cellForRowAtIndexPath:(NSIndexPath *)indexPath {

    BookCell *cell = [tableView dequeueReusableCellWithIdentifier:@"BookCell"
                                                      forIndexPath:indexPath];

    cell.bookTitle = self.bookTitles[indexPath.row];

    return cell;
}

// âœ… æ­¥éª¤2ï¼šä¸å®ç° heightForRowAtIndexPath:
// è®©ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—

@end

// âœ… æ­¥éª¤3ï¼šç¡®ä¿ Cell çš„çº¦æŸå®Œæ•´
@implementation BookCell

- (void)setupConstraints {
    [NSLayoutConstraint activateConstraints:@[
        // â­ ä» top åˆ° bottom çš„å®Œæ•´çº¦æŸé“¾
        [self.titleLabel.topAnchor constraintEqualToAnchor:self.contentView.topAnchor
                                                  constant:12],
        [self.titleLabel.leadingAnchor constraintEqualToAnchor:self.contentView.leadingAnchor
                                                       constant:16],
        [self.titleLabel.trailingAnchor constraintEqualToAnchor:self.contentView.trailingAnchor
                                                        constant:-16],
        [self.titleLabel.bottomAnchor constraintEqualToAnchor:self.contentView.bottomAnchor
                                                     constant:-12]  // â­ å…³é”®
    ]];
}

@end
```

### **ä¸ºä»€ä¹ˆè¿™æ ·æ›´å¥½ï¼Ÿ**

1. âœ… **ç®€æ´**ï¼šåªéœ€ 2 è¡Œé…ç½®
2. âœ… **é«˜æ€§èƒ½**ï¼šç³»ç»Ÿä¼˜åŒ–è¿‡çš„è‡ªåŠ¨è®¡ç®—
3. âœ… **æ˜“ç»´æŠ¤**ï¼šä¸éœ€è¦ç»´æŠ¤ sizingCell å’Œè®¡ç®—é€»è¾‘
4. âœ… **è‡ªåŠ¨é€‚é…**ï¼šå±å¹•æ—‹è½¬ã€å­—ä½“å¤§å°å˜åŒ–è‡ªåŠ¨å¤„ç†
5. âœ… **æ— çŸ›ç›¾**ï¼šé€»è¾‘æ¸…æ™°ä¸€è‡´

---

## ğŸ¯ ä»€ä¹ˆæ—¶å€™æ‰éœ€è¦å®ç° heightForRowAtIndexPath:ï¼Ÿ

### **åœºæ™¯1ï¼šå®Œå…¨å›ºå®šé«˜åº¦**

```objective-c
- (void)viewDidLoad {
    // ä¸è®¾ç½® rowHeight
}

- (CGFloat)tableView:(UITableView *)tableView
heightForRowAtIndexPath:(NSIndexPath *)indexPath {
    return 80;  // å›ºå®šé«˜åº¦
}
```

---

### **åœºæ™¯2ï¼šä¸åŒç±»å‹ Cell ä¸åŒé«˜åº¦**

```objective-c
- (CGFloat)tableView:(UITableView *)tableView
heightForRowAtIndexPath:(NSIndexPath *)indexPath {

    if (indexPath.row == 0) {
        return 200;  // Header Cell
    } else if (æŸç‰¹æ®Šæ¡ä»¶) {
        return 100;  // ç‰¹æ®Š Cell
    }

    return UITableViewAutomaticDimension;  // å…¶ä»– Cell è‡ªåŠ¨è®¡ç®—
}
```

---

### **åœºæ™¯3ï¼šæ ¹æ®ç®€å•æ•°æ®è®¡ç®—ï¼ˆä¸éœ€è¦ sizingCellï¼‰**

```objective-c
- (CGFloat)tableView:(UITableView *)tableView
heightForRowAtIndexPath:(NSIndexPath *)indexPath {

    NSString *text = self.data[indexPath.row];

    // ç®€å•è®¡ç®—æ–‡æœ¬é«˜åº¦
    CGFloat width = tableView.bounds.size.width - 32;
    CGRect rect = [text boundingRectWithSize:CGSizeMake(width, CGFLOAT_MAX)
                                     options:NSStringDrawingUsesLineFragmentOrigin
                                  attributes:@{NSFontAttributeName: [UIFont systemFontOfSize:16]}
                                     context:nil];

    return ceil(rect.size.height) + 24;  // æ–‡æœ¬é«˜åº¦ + ä¸Šä¸‹è¾¹è·
}
```

---

## ğŸ“Š æ€»ç»“å¯¹æ¯”

| ç‰¹æ€§ | è‡ªåŠ¨é«˜åº¦ï¼ˆæ¨èï¼‰ | æ‰‹åŠ¨ systemLayoutSizeFittingSizeï¼ˆä¸æ¨èï¼‰ |
|------|----------------|---------------------------------------|
| **è®¾ç½®å¤æ‚åº¦** | â­ ç®€å•ï¼ˆ2è¡Œï¼‰ | â­â­â­ å¤æ‚ï¼ˆ20+è¡Œï¼‰ |
| **æ€§èƒ½** | â­â­â­â­â­ ä¼˜ç§€ | â­â­ å·®ï¼ˆ10å€æ…¢ï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | â­â­â­â­â­ ä½ | â­â­ é«˜ |
| **é€»è¾‘ä¸€è‡´æ€§** | â­â­â­â­â­ æ¸…æ™° | â­ çŸ›ç›¾ |
| **é€‚é…æ€§** | â­â­â­â­â­ è‡ªåŠ¨ | â­â­ éœ€è¦æ‰‹åŠ¨å¤„ç† |

---

## ğŸ‰ ç»“è®º

### **ä¸‰å¥è¯æ€»ç»“ï¼š**

1. âœ… **è®¾ç½®äº† `UITableViewAutomaticDimension`ï¼Œå°±ä¸è¦å®ç° `heightForRowAtIndexPath:`**
2. âœ… **è®©ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—ï¼Œæ€§èƒ½æ›´å¥½ã€ä»£ç æ›´ç®€æ´**
3. âœ… **åªæœ‰åœ¨ç‰¹æ®Šæƒ…å†µä¸‹ï¼ˆå›ºå®šé«˜åº¦ã€æ··åˆé«˜åº¦ï¼‰æ‰éœ€è¦æ‰‹åŠ¨æ§åˆ¶**

### **è®°ä½è¿™ä¸ªæµç¨‹ï¼š**

```
è®¾ç½®è‡ªåŠ¨é«˜åº¦
    â†“
ç¡®ä¿ Cell çº¦æŸå®Œæ•´
    â†“
ä¸å®ç° heightForRowAtIndexPath:
    â†“
å®Œæˆï¼
```

**ä¸è¦ç”»è›‡æ·»è¶³ï¼** ğŸ¯

